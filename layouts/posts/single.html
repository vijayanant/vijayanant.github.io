{{ define "main" }}
<section id="blog-detail">
  <div class="container">
    <div class="post-layout">

      <!-- Post Content -->
      <div class="post-content">
        <article>
          <header>
            <h1>{{ .Title }}</h1>
            <p class="text-muted">{{ .Date.Format "January 2, 2006" }}</p>
          </header>

          <div class="content">
            {{ .Content }}
          </div>
        </article>

        {{ if .Params.series }}
          {{ $seriesName := .Params.series }}
          {{ $pagesInSeries := where site.RegularPages "Params.series" $seriesName }}
          {{ $sortedPages := $pagesInSeries.ByParam "series_order" }}
          {{ $currentPostIndex := -1 }}
          {{ range $i, $p := $sortedPages }}
            {{ if eq .Permalink $.Permalink }}
              {{ $currentPostIndex = $i }}
            {{ end }}
          {{ end }}

          {{ $nextPost := false }}
          {{ if lt $currentPostIndex (sub (len $sortedPages) 1) }}
            {{ $nextPost = index $sortedPages (add $currentPostIndex 1) }}
          {{ end }}

          {{ if $nextPost }}
            <div class="next-post-prompt">
              <p>Continue the series:</p>
              <a href="{{ $nextPost.Permalink }}" class="button button-primary">
                Next: {{ $nextPost.Title }}
              </a>
            </div>
          {{ else }}
            {{/* Last post in series */}}
            <div class="next-post-prompt">
              <p>You've reached the end of the series!</p>
              <a href="{{ site.BaseURL }}series/{{ $seriesName | urlize }}/" class="button button-primary">
                Explore More from "{{ $seriesName }}"
              </a>
            </div>
            {{ partial "related-posts.html" . }}
          {{ end }}
        {{ else }}
          {{/* Standalone post */}}
          {{ partial "related-posts.html" . }}
        {{ end }}

      </div>

      <!-- Sidebar -->
      <div class="post-sidebar">
        <div class="sticky-top">
          {{ with .Params.series }}
            {{ $seriesName := . }}
            {{ $pagesInSeries := where site.RegularPages "Params.series" $seriesName }}
            {{ $sortedPages := $pagesInSeries.ByParam "series_order" }}
            <div class="series-nav mb-4">
              <h5>Part of the "{{ $seriesName }}" series</h5>
              <ol>
                {{ range $sortedPages }}
                  <li class="{{ if eq .Permalink $.Permalink }}fw-bold{{ end }}">
                    <a href="{{ .Permalink }}">{{ .Title }}</a>
                  </li>
                {{ end }}
              </ol>
            </div>
          {{ end }}

          {{ if .TableOfContents }}
          <div class="toc-nav">
            <h5>On this page</h5>
            {{ .TableOfContents }}
          </div>
          {{ end }}
        </div>
      </div>

    </div>
  </div>
</section>
{{ end }}